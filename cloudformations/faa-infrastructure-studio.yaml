AWSTemplateFormatVersion: '2010-09-09'
Description: 'FAA Infrastructure with DocumentDB, Elastic Beanstalk, and Solace'

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: "Network Configuration"
        Parameters: []
      - Label:
          default: "Access Configuration"
        Parameters:
          - KeyPairName
    ParameterLabels:

      KeyPairName:
        default: "EC2 Key Pair (Optional)"

Parameters:
  KeyPairName:
    Type: String
    Description: EC2 Key Pair for SSH access (optional)
    Default: ''

Conditions:
  HasKeyPair: !Not [!Equals [!Ref KeyPairName, '']]

Resources:


  # Get Default Subnets
  GetDefaultSubnetsFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: GetDefaultSubnets
      Runtime: python3.9
      Handler: index.handler
      Role: !GetAtt GetDefaultSubnetsRole.Arn
      Timeout: 60
      Code:
        ZipFile: |
          import boto3
          import cfnresponse
          
          def handler(event, context):
              try:
                  if event['RequestType'] == 'Create':
                      ec2 = boto3.client('ec2')
                      
                      # Get default VPC
                      vpcs = ec2.describe_vpcs(Filters=[{'Name': 'is-default', 'Values': ['true']}])
                      if not vpcs['Vpcs']:
                          raise Exception('No default VPC found')
                      
                      vpc_id = vpcs['Vpcs'][0]['VpcId']
                      
                      # Get subnets in default VPC
                      subnets = ec2.describe_subnets(Filters=[{'Name': 'vpc-id', 'Values': [vpc_id]}])
                      subnet_ids = [s['SubnetId'] for s in subnets['Subnets'][:2]]  # Take first 2
                      
                      if len(subnet_ids) < 2:
                          raise Exception('Need at least 2 subnets in default VPC')
                      
                      cfnresponse.send(event, context, cfnresponse.SUCCESS, {
                          'SubnetIds': ','.join(subnet_ids)
                      })
                  else:
                      cfnresponse.send(event, context, cfnresponse.SUCCESS, {})
              except Exception as e:
                  print(e)
                  cfnresponse.send(event, context, cfnresponse.FAILED, {})

  # Lambda execution role for getting subnets
  GetDefaultSubnetsRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: EC2Access
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - ec2:DescribeVpcs
                  - ec2:DescribeSubnets
                Resource: '*'

  # Custom resource to get default subnets
  GetDefaultSubnetsResource:
    Type: AWS::CloudFormation::CustomResource
    Properties:
      ServiceToken: !GetAtt GetDefaultSubnetsFunction.Arn

  # Secrets Manager for DocumentDB password
  DocumentDBSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: faa/documentdb/password
      Description: DocumentDB password for FAA cluster
      SecretString: !Sub
        - '{"spring.data.mongodb.uri": "mongodb://faa:${Password}@${Endpoint}:27017/?replicaSet=rs0&readPreference=secondaryPreferred&retryWrites=false&tls=false"}'
        - Password: !Sub '{{resolve:secretsmanager:${DocumentDBPasswordSecret}:SecretString:password}}'
          Endpoint: !GetAtt DocumentDBCluster.Endpoint

  # Separate secret for DocumentDB password
  DocumentDBPasswordSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: faa/documentdb/password-internal
      Description: Internal DocumentDB password storage
      SecretString: '{"username": "faa", "password": "faaistheb3st"}'

  # Solace SCDS Broker Secret
  SolaceBrokerSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: solace/scds/broker
      Description: Solace broker configuration for SCDS
      SecretString: !Sub |
        {
          "spring.cloud.stream.binders.local-solace.environment.solace.java.host": "tcps://mr-connection-57h4pe49129.messaging.solace.cloud:55443",
          "spring.cloud.stream.binders.local-solace.environment.solace.java.username": "reinvent25",
          "spring.cloud.stream.binders.local-solace.environment.solace.java.password": "reinvent25"
        }

  # AWS Account ID Secret
  AWSAccountIDSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: aws/accountid
      Description: AWS Account ID for FAA workshop
      SecretString: !Sub '{"aws_account_id": "${AWS::AccountId}"}'

  # DocumentDB Parameter Group
  DocumentDBParameterGroup:
    Type: AWS::DocDB::DBClusterParameterGroup
    Properties:
      Description: Parameter group for DocumentDB with TLS disabled
      Family: docdb5.0
      Parameters:
        tls: "disabled"

  # DocumentDB Subnet Group
  DocumentDBSubnetGroup:
    Type: AWS::DocDB::DBSubnetGroup
    Properties:
      DBSubnetGroupName: faa-documentdb-subnet-group
      DBSubnetGroupDescription: Subnet group for DocumentDB
      SubnetIds: !Split [',', !GetAtt GetDefaultSubnetsResource.SubnetIds]

  # DocumentDB Security Group
  DocumentDBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for DocumentDB
      VpcId: !GetAtt GetDefaultVPCResource.VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 27017
          ToPort: 27017
          CidrIp: 0.0.0.0/0
  # DocumentDB Cluster
  DocumentDBCluster:
    Type: AWS::DocDB::DBCluster
    Properties:
      DBClusterIdentifier: faa-data
      MasterUsername: faa
      MasterUserPassword: !Sub '{{resolve:secretsmanager:${DocumentDBPasswordSecret}:SecretString:password}}'
      DBSubnetGroupName: !Ref DocumentDBSubnetGroup
      DBClusterParameterGroupName: !Ref DocumentDBParameterGroup
      VpcSecurityGroupIds:
        - !Ref DocumentDBSecurityGroup
      StorageEncrypted: true
      BackupRetentionPeriod: 7
      PreferredBackupWindow: "03:00-04:00"
      PreferredMaintenanceWindow: "sun:04:00-sun:05:00"

  # DocumentDB Instances
  DocumentDBInstance1:
    Type: AWS::DocDB::DBInstance
    Properties:
      DBClusterIdentifier: !Ref DocumentDBCluster
      DBInstanceClass: db.t3.medium
      
  DocumentDBInstance2:
    Type: AWS::DocDB::DBInstance
    Properties:
      DBClusterIdentifier: !Ref DocumentDBCluster
      DBInstanceClass: db.t3.medium
      
  DocumentDBInstance3:
    Type: AWS::DocDB::DBInstance
    Properties:
      DBClusterIdentifier: !Ref DocumentDBCluster
      DBInstanceClass: db.t3.medium

  # Elastic Beanstalk Application
  ElasticBeanstalkApplication:
    Type: AWS::ElasticBeanstalk::Application
    Properties:
      ApplicationName: FDPS
      Description: FAA Data Processing System

  # STDDS Elastic Beanstalk Application
  STDDSElasticBeanstalkApplication:
    Type: AWS::ElasticBeanstalk::Application
    Properties:
      ApplicationName: STDDS
      Description: STDDS Data Processing System

  # S3 Bucket for application
  FDPSApplicationS3Bucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub 'fdps-app-${AWS::AccountId}-${AWS::Region}-${AWS::StackName}'
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true

  # S3 Bucket for STDDS application
  STDDSApplicationS3Bucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub 'stdds-app-${AWS::AccountId}-${AWS::Region}-${AWS::StackName}'
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true

  # Lambda to download JAR file
  DownloadJarFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: DownloadFDPSJar
      Runtime: python3.9
      Handler: index.handler
      Role: !GetAtt DownloadJarRole.Arn
      Timeout: 300
      Code:
        ZipFile: |
          import boto3
          import urllib.request
          import cfnresponse
          
          def handler(event, context):
              try:
                  if event['RequestType'] == 'Create':
                      s3 = boto3.client('s3')
                      bucket = event['ResourceProperties']['Bucket']
                      key = event['ResourceProperties']['Key']
                      url = event['ResourceProperties']['Url']
                      
                      urllib.request.urlretrieve(url, '/tmp/app.jar')
                      s3.upload_file('/tmp/app.jar', bucket, key)
                      
                  cfnresponse.send(event, context, cfnresponse.SUCCESS, {})
              except Exception as e:
                  print(e)
                  cfnresponse.send(event, context, cfnresponse.FAILED, {})

  # Lambda execution role
  DownloadJarRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: S3Access
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:PutObject
                Resource: 
                  - !Sub 'arn:aws:s3:::${FDPSApplicationS3Bucket}/*'
                  - !Sub 'arn:aws:s3:::${STDDSApplicationS3Bucket}/*'

  # Custom resource to download FDPS JAR
  DownloadFDPSJarResource:
    Type: AWS::CloudFormation::CustomResource
    Properties:
      ServiceToken: !GetAtt DownloadJarFunction.Arn
      Bucket: !Ref FDPSApplicationS3Bucket
      Key: FDPS-Position-Sink-0.0.3-SNAPSHOT.jar
      Url: https://github.com/jschabowsky/solace-faa-scds-demo/releases/download/0.0.3/FDPS-Position-Sink-0.0.3-SNAPSHOT.jar

  # Custom resource to download STDDS JAR
  DownloadSTDDSJarResource:
    Type: AWS::CloudFormation::CustomResource
    Properties:
      ServiceToken: !GetAtt DownloadJarFunction.Arn
      Bucket: !Ref STDDSApplicationS3Bucket
      Key: STDDS-Position-Sink-0.0.3-SNAPSHOT.jar
      Url: https://github.com/jschabowsky/solace-faa-scds-demo/releases/download/0.0.3/STDDS-Position-Sink-0.0.3-SNAPSHOT.jar

  # Download Flight Plan JAR Resource
  DownloadFlightPlanJarResource:
    Type: AWS::CloudFormation::CustomResource
    Properties:
      ServiceToken: !GetAtt DownloadJarFunction.Arn
      Bucket: !Ref FDPSApplicationS3Bucket
      Key: FDPS-FlightPlan-Sink-0.0.3-SNAPSHOT.jar
      Url: https://github.com/jschabowsky/solace-faa-scds-demo/releases/download/0.0.3/FDPS-FlightPlan-Sink-0.0.3-SNAPSHOT.jar

  # FDPS Elastic Beanstalk Application Version
  FDPSElasticBeanstalkApplicationVersion:
    Type: AWS::ElasticBeanstalk::ApplicationVersion
    DependsOn: DownloadFDPSJarResource
    Properties:
      ApplicationName: !Ref ElasticBeanstalkApplication
      Description: FDPS Application Version
      SourceBundle:
        S3Bucket: !Ref FDPSApplicationS3Bucket
        S3Key: FDPS-Position-Sink-0.0.3-SNAPSHOT.jar

  # Flight Plan Elastic Beanstalk Application Version
  FlightPlanElasticBeanstalkApplicationVersion:
    Type: AWS::ElasticBeanstalk::ApplicationVersion
    DependsOn: DownloadFlightPlanJarResource
    Properties:
      ApplicationName: !Ref ElasticBeanstalkApplication
      Description: Flight Plan Application Version
      SourceBundle:
        S3Bucket: !Ref FDPSApplicationS3Bucket
        S3Key: FDPS-FlightPlan-Sink-0.0.3-SNAPSHOT.jar

  # STDDS Elastic Beanstalk Application Version
  STDDSElasticBeanstalkApplicationVersion:
    Type: AWS::ElasticBeanstalk::ApplicationVersion
    DependsOn: DownloadSTDDSJarResource
    Properties:
      ApplicationName: !Ref STDDSElasticBeanstalkApplication
      Description: STDDS Application Version
      SourceBundle:
        S3Bucket: !Ref STDDSApplicationS3Bucket
        S3Key: STDDS-Position-Sink-0.0.3-SNAPSHOT.jar

  # Elastic Beanstalk Security Group
  ElasticBeanstalkSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Elastic Beanstalk environments
      VpcId: !GetAtt GetDefaultVPCResource.VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0

  # Elastic Beanstalk Service Role
  ElasticBeanstalkServiceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: elasticbeanstalk.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSElasticBeanstalkEnhancedHealth
        - arn:aws:iam::aws:policy/AWSElasticBeanstalkManagedUpdatesCustomerRolePolicy

  # Elastic Beanstalk Instance Profile
  ElasticBeanstalkInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - !Ref ElasticBeanstalkInstanceRole

  # Elastic Beanstalk Instance Role
  ElasticBeanstalkInstanceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AWSElasticBeanstalkWebTier
        - arn:aws:iam::aws:policy/AWSElasticBeanstalkMulticontainerDocker
        - arn:aws:iam::aws:policy/AWSElasticBeanstalkWorkerTier
      Policies:
        - PolicyName: SecretsManagerAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - secretsmanager:GetSecretValue
                Resource:
                  - !Ref DocumentDBSecret
                  - !Ref DocumentDBPasswordSecret
                  - !Ref SolaceBrokerSecret
                  - !Ref AWSAccountIDSecret

  # Elastic Beanstalk Environment
  FDPSElasticBeanstalkEnvironment:
    Type: AWS::ElasticBeanstalk::Environment
    Properties:
      ApplicationName: !Ref ElasticBeanstalkApplication
      EnvironmentName: FDPS-Environment
      SolutionStackName: "64bit Amazon Linux 2023 v4.8.0 running Corretto 17"
      VersionLabel: !Ref FDPSElasticBeanstalkApplicationVersion
      OptionSettings:
        - Namespace: aws:elasticbeanstalk:environment
          OptionName: EnvironmentType
          Value: SingleInstance
        - Namespace: aws:elasticbeanstalk:environment
          OptionName: ServiceRole
          Value: !Ref ElasticBeanstalkServiceRole
        - Namespace: aws:autoscaling:launchconfiguration
          OptionName: IamInstanceProfile
          Value: !Ref ElasticBeanstalkInstanceProfile
        - Namespace: aws:autoscaling:launchconfiguration
          OptionName: SecurityGroups
          Value: !Ref ElasticBeanstalkSecurityGroup
        - Namespace: aws:ec2:vpc
          OptionName: VPCId
          Value: !GetAtt GetDefaultVPCResource.VpcId
        - Namespace: aws:ec2:vpc
          OptionName: Subnets
          Value: !GetAtt GetDefaultSubnetsResource.SubnetIds
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: SPRING_DATA_MONGODB_URI
          Value: !Sub '{{resolve:secretsmanager:${DocumentDBSecret}:SecretString:spring.data.mongodb.uri}}'
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: SPRING_CLOUD_STREAM_BINDERS_LOCAL_SOLACE_ENVIRONMENT_SOLACE_JAVA_HOST
          Value: !Sub '{{resolve:secretsmanager:${SolaceBrokerSecret}:SecretString:spring.cloud.stream.binders.local-solace.environment.solace.java.host}}'
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: SPRING_CLOUD_STREAM_BINDERS_LOCAL_SOLACE_ENVIRONMENT_SOLACE_JAVA_USERNAME
          Value: !Sub '{{resolve:secretsmanager:${SolaceBrokerSecret}:SecretString:spring.cloud.stream.binders.local-solace.environment.solace.java.username}}'
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: SPRING_CLOUD_STREAM_BINDERS_LOCAL_SOLACE_ENVIRONMENT_SOLACE_JAVA_PASSWORD
          Value: !Sub '{{resolve:secretsmanager:${SolaceBrokerSecret}:SecretString:spring.cloud.stream.binders.local-solace.environment.solace.java.password}}'
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: AWS_ACCOUNT_ID
          Value: !Sub '{{resolve:secretsmanager:${AWSAccountIDSecret}:SecretString:aws_account_id}}'

  # STDDS Elastic Beanstalk Environment
  STDDSElasticBeanstalkEnvironment:
    Type: AWS::ElasticBeanstalk::Environment
    Properties:
      ApplicationName: !Ref STDDSElasticBeanstalkApplication
      EnvironmentName: STDDS-Environment
      SolutionStackName: "64bit Amazon Linux 2023 v4.8.0 running Corretto 17"
      VersionLabel: !Ref STDDSElasticBeanstalkApplicationVersion
      OptionSettings:
        - Namespace: aws:elasticbeanstalk:environment
          OptionName: EnvironmentType
          Value: SingleInstance
        - Namespace: aws:elasticbeanstalk:environment
          OptionName: ServiceRole
          Value: !Ref ElasticBeanstalkServiceRole
        - Namespace: aws:autoscaling:launchconfiguration
          OptionName: IamInstanceProfile
          Value: !Ref ElasticBeanstalkInstanceProfile
        - Namespace: aws:autoscaling:launchconfiguration
          OptionName: SecurityGroups
          Value: !Ref ElasticBeanstalkSecurityGroup
        - Namespace: aws:ec2:vpc
          OptionName: VPCId
          Value: !GetAtt GetDefaultVPCResource.VpcId
        - Namespace: aws:ec2:vpc
          OptionName: Subnets
          Value: !GetAtt GetDefaultSubnetsResource.SubnetIds
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: SPRING_DATA_MONGODB_URI
          Value: !Sub '{{resolve:secretsmanager:${DocumentDBSecret}:SecretString:spring.data.mongodb.uri}}'
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: SPRING_CLOUD_STREAM_BINDERS_LOCAL_SOLACE_ENVIRONMENT_SOLACE_JAVA_HOST
          Value: !Sub '{{resolve:secretsmanager:${SolaceBrokerSecret}:SecretString:spring.cloud.stream.binders.local-solace.environment.solace.java.host}}'
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: SPRING_CLOUD_STREAM_BINDERS_LOCAL_SOLACE_ENVIRONMENT_SOLACE_JAVA_USERNAME
          Value: !Sub '{{resolve:secretsmanager:${SolaceBrokerSecret}:SecretString:spring.cloud.stream.binders.local-solace.environment.solace.java.username}}'
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: SPRING_CLOUD_STREAM_BINDERS_LOCAL_SOLACE_ENVIRONMENT_SOLACE_JAVA_PASSWORD
          Value: !Sub '{{resolve:secretsmanager:${SolaceBrokerSecret}:SecretString:spring.cloud.stream.binders.local-solace.environment.solace.java.password}}'
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: AWS_ACCOUNT_ID
          Value: !Sub '{{resolve:secretsmanager:${AWSAccountIDSecret}:SecretString:aws_account_id}}'

  # Flight Plan Elastic Beanstalk Environment
  FlightPlanElasticBeanstalkEnvironment:
    Type: AWS::ElasticBeanstalk::Environment
    Properties:
      ApplicationName: !Ref ElasticBeanstalkApplication
      EnvironmentName: FlightPlan-Environment
      SolutionStackName: "64bit Amazon Linux 2023 v4.8.0 running Corretto 17"
      VersionLabel: !Ref FlightPlanElasticBeanstalkApplicationVersion
      OptionSettings:
        - Namespace: aws:elasticbeanstalk:environment
          OptionName: EnvironmentType
          Value: SingleInstance
        - Namespace: aws:elasticbeanstalk:environment
          OptionName: ServiceRole
          Value: !Ref ElasticBeanstalkServiceRole
        - Namespace: aws:autoscaling:launchconfiguration
          OptionName: IamInstanceProfile
          Value: !Ref ElasticBeanstalkInstanceProfile
        - Namespace: aws:autoscaling:launchconfiguration
          OptionName: SecurityGroups
          Value: !Ref ElasticBeanstalkSecurityGroup
        - Namespace: aws:ec2:vpc
          OptionName: VPCId
          Value: !GetAtt GetDefaultVPCResource.VpcId
        - Namespace: aws:ec2:vpc
          OptionName: Subnets
          Value: !GetAtt GetDefaultSubnetsResource.SubnetIds
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: SPRING_DATA_MONGODB_URI
          Value: !Sub '{{resolve:secretsmanager:${DocumentDBSecret}:SecretString:spring.data.mongodb.uri}}'
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: SPRING_CLOUD_STREAM_BINDERS_LOCAL_SOLACE_ENVIRONMENT_SOLACE_JAVA_HOST
          Value: !Sub '{{resolve:secretsmanager:${SolaceBrokerSecret}:SecretString:spring.cloud.stream.binders.local-solace.environment.solace.java.host}}'
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: SPRING_CLOUD_STREAM_BINDERS_LOCAL_SOLACE_ENVIRONMENT_SOLACE_JAVA_USERNAME
          Value: !Sub '{{resolve:secretsmanager:${SolaceBrokerSecret}:SecretString:spring.cloud.stream.binders.local-solace.environment.solace.java.username}}'
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: SPRING_CLOUD_STREAM_BINDERS_LOCAL_SOLACE_ENVIRONMENT_SOLACE_JAVA_PASSWORD
          Value: !Sub '{{resolve:secretsmanager:${SolaceBrokerSecret}:SecretString:spring.cloud.stream.binders.local-solace.environment.solace.java.password}}'
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: AWS_ACCOUNT_ID
          Value: !Sub '{{resolve:secretsmanager:${AWSAccountIDSecret}:SecretString:aws_account_id}}'

  # Get Default VPC
  GetDefaultVPCFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: GetDefaultVPC
      Runtime: python3.9
      Handler: index.handler
      Role: !GetAtt GetDefaultSubnetsRole.Arn
      Timeout: 60
      Code:
        ZipFile: |
          import boto3
          import cfnresponse
          
          def handler(event, context):
              try:
                  if event['RequestType'] == 'Create':
                      ec2 = boto3.client('ec2')
                      
                      # Get default VPC
                      vpcs = ec2.describe_vpcs(Filters=[{'Name': 'is-default', 'Values': ['true']}])
                      if not vpcs['Vpcs']:
                          raise Exception('No default VPC found')
                      
                      vpc_id = vpcs['Vpcs'][0]['VpcId']
                      
                      cfnresponse.send(event, context, cfnresponse.SUCCESS, {
                          'VpcId': vpc_id
                      })
                  else:
                      cfnresponse.send(event, context, cfnresponse.SUCCESS, {})
              except Exception as e:
                  print(e)
                  cfnresponse.send(event, context, cfnresponse.FAILED, {})

  # Custom resource to get default VPC
  GetDefaultVPCResource:
    Type: AWS::CloudFormation::CustomResource
    Properties:
      ServiceToken: !GetAtt GetDefaultVPCFunction.Arn

  # EC2 Security Group for Solace
  SolaceSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Solace broker
      VpcId: !GetAtt GetDefaultVPCResource.VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 8080
          ToPort: 8080
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 55555
          ToPort: 55555
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 8008
          ToPort: 8008
          CidrIp: 0.0.0.0/0

  # EC2 Instance for Solace
  SolaceInstance:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !Sub '{{resolve:ssm:/aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2}}'
      InstanceType: t3.medium

      SecurityGroupIds:
        - !Ref SolaceSecurityGroup
      SubnetId: !Select [0, !Split [',', !GetAtt GetDefaultSubnetsResource.SubnetIds]]
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          yum update -y
          yum install -y docker git
          systemctl start docker
          systemctl enable docker
          usermod -a -G docker ec2-user
          
          # Install docker-compose
          curl -L "https://github.com/docker/compose/releases/download/1.29.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          chmod +x /usr/local/bin/docker-compose
          
          # Clone and run Solace
          cd /home/ec2-user
          git clone https://github.com/SolaceLabs/solace-single-docker-compose.git
          cd solace-single-docker-compose/template
          docker-compose -f PubSubStandard_singleNode.yml up -d
          
          # Log status for verification
          echo "Docker status:" >> /var/log/solace-setup.log
          docker ps >> /var/log/solace-setup.log
          echo "Setup completed at $(date)" >> /var/log/solace-setup.log
      Tags:
        - Key: Name
          Value: Solace-Broker

Outputs:
  DocumentDBEndpoint:
    Description: DocumentDB cluster endpoint
    Value: !GetAtt DocumentDBCluster.Endpoint
    
  SolaceBrokerEndpoint:
    Description: Solace broker EC2 instance endpoint URL
    Value: !GetAtt SolaceInstance.PublicDnsName
    
  FAABrokerHOST:
    Description: FAA Broker Host
    Value: tcps://mr-connection-57h4pe49129.messaging.solace.cloud:55443

  FAABrokerUSER:
    Description: FAA Broker User
    Value: reinvent25

  FAABrokerPASS:
    Description: FAA Broker Password
    Value: reinvent25

  FAABrokerMSGVPN:
    Description: FAA Broker Message VPN
    Value: scds